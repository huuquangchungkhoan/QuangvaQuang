name: Vietcap Data Refresh

on:
  schedule:
    # Run every 30 minutes during Vietnam market hours (8:45-15:00 VN = 1:45-8:00 UTC)
    # Weekdays only: at :15 and :45 of each hour from 1-7 UTC
    - cron: '15,45 1-7 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh-vietcap-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install vnstock boto3 pandas requests
      
      - name: Fetch screener and funds
        run: |
          cd $GITHUB_WORKSPACE
          
          # Run screener and funds in parallel
          python scripts/fetch_screener.py &
          PID1=$!
          
          python scripts/fetch_funds_hybrid.py &
          PID2=$!
          
          # Wait for both to complete
          wait $PID1
          EXIT1=$?
          
          wait $PID2
          EXIT2=$?
          
          # Check if any failed
          if [ $EXIT1 -ne 0 ] || [ $EXIT2 -ne 0 ]; then
            echo "‚ùå One or more fetches failed:"
            echo "Screener: $EXIT1"
            echo "Funds: $EXIT2"
            exit 1
          fi
          
          echo "‚úÖ Screener and funds fetched successfully!"
      
      - name: Upload to Cloudflare R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_CUSTOM_DOMAIN: ${{ secrets.R2_CUSTOM_DOMAIN }}
        run: |
          cd $GITHUB_WORKSPACE
          python scripts/upload_to_r2.py
      
      - name: Summary
        run: |
          echo "üìä Data Summary:"
          echo "Screener: $(ls -lh data/screener.json | awk '{print $5}')"
          echo "Funds: $(ls -lh data/funds.json | awk '{print $5}')"
